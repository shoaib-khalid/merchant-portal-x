<ng-container>
    <div class="shadow rounded-2xl bg-card">
        <div class="flex flex-col flex-auto items-center m-5 p-6 sm:p-10">
            <div class="w-full">
                <!-- Form -->
                <form [formGroup]="storeDeliveryForm">
                    <!-- Section -->
                    <div class="w-full">
                        <div class="text-xl">Payment Details</div>
                        <div class="text-secondary">Choose your type of delivery types to provide to the customer of delivery details.</div>
                    </div>
                    <div class="grid grid-cols-4 gap-6 w-full mt-8">
                        <!-- Card holder -->
                        <div class="col-span-4">
                            <mat-form-field class="fuse-mat-no-subscript w-full">
                                <mat-label>Delivery Type</mat-label>
                                    <mat-select
                                    [formControlName]="'deliveryType'"
                                    [required]="true"
                                    [value]="'deliveryType'"
                                    [placeholder]="'Select Delivery Type'"
                                    (selectionChange)="storeDeliveryForm.get('deliveryType').patchValue($event.value)"
                                    (selectionChange)="checkDeliveryPartner()"
                                    #deliverySelector="matSelect"
                                    >
                                    <mat-select-trigger>
                                        <span class="flex items-center">
                                            <span>{{ deliverySelector.triggerValue }}</span>
                                        </span>
                                    </mat-select-trigger>
                                    <div>
                                        <mat-option [value]="'SELF'">Self Delivery</mat-option>
                                        <mat-option 
                                            *ngIf="this.storeDeliveryForm.get('verticalCode').value === 'E-Commerce' || this.storeDeliveryForm.get('verticalCode').value === 'e-commerce-b2b2c' || this.storeDeliveryForm.get('verticalCode').value === 'ECommerce_PK'" 
                                            [value]="'SCHEDULED'">Regular Delivery</mat-option>
                                        <mat-option 
                                        *ngIf="this.storeDeliveryForm.get('verticalCode').value === 'FnB' || this.storeDeliveryForm.get('verticalCode').value === 'FnB_PK'"
                                            [value]="'ADHOC'">Delivery Partner</mat-option>
                                    </div>
                                </mat-select>
                                <mat-error *ngIf="storeDeliveryForm.get('deliveryType').hasError('required')">
                                    Required
                                </mat-error>
                                <mat-error *ngIf="storeDeliveryForm.get('deliveryType').hasError('noDeliveryPartners')">
                                    No available delivery partner
                                </mat-error>
                                <mat-icon
                                    matPrefix
                                    [svgIcon]="'mat_solid:delivery_dining'">
                                </mat-icon>
                            </mat-form-field>
                        </div>
                        <!-- Delivery Fullfillment -->
                        <div class="col-span-4 mb-3">
                            <div class="flex flex-col w-full">
                                <mat-label class="font-medium">Delivery Fulfillment *</mat-label>
                                <div class="flex flex-col sm:flex-row">
                                    <!-- <div class="flex w-full lg:w-2/4">
                                        <mat-checkbox class="" [formControlName]="'allowScheduledDelivery'" [checked]="deliveryFullfilment[2].selected">{{deliveryFullfilment[2].label}}</mat-checkbox>
                                        <mat-icon
                                            [matTooltip]="deliveryFullfilment[2].tooltip"
                                            class="flex flex-wrap transform scale-75"
                                            [svgIcon]="'heroicons_solid:question-mark-circle'">
                                        </mat-icon>
                                    </div> -->
                                    <div class="flex w-full lg:w-2/4">
                                        <mat-checkbox class="" [formControlName]="'allowStorePickup'" [checked]="deliveryFullfilment[3].selected">{{deliveryFullfilment[3].label}}</mat-checkbox>
                                        <mat-icon
                                            [matTooltip]="deliveryFullfilment[3].tooltip"
                                            class="flex flex-wrap transform scale-75"
                                            [svgIcon]="'heroicons_solid:question-mark-circle'">
                                        </mat-icon>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Delivery Partner, Self Delivery -->
                        <div class="col-span-4">
                            <!-- Delivery Partner -->
                            <div *ngIf="storeDeliveryForm.get('deliveryType').value === 'SCHEDULED' || storeDeliveryForm.get('deliveryType').value === 'ADHOC'" class="flex flex-col w-full">
                                <div class="col-span-4">
                                    <mat-label class="flex flex-col font-medium">Delivery Partner *</mat-label>
                                    <mat-icon
                                        matTooltip="Below delivery partner will be provided to the customer to choose when purchasing from this store."
                                        class="flex flex-wrap transform scale-75"
                                        [svgIcon]="'heroicons_solid:question-mark-circle'">
                                    </mat-icon>
                                </div>
                                <div class="mb-0.5"></div>
                                <div class="border border-gray-300 rounded min-h-26 max-h-72 overflow-auto">
                                    <div class="pt-4 pl-2 w-full">
                                        <section class="flex flex-col px-2" *ngFor="let deliveryPartner of deliveryPartners">
                                            <mat-form-field
                                                appearance="fill" 
                                                floatLabel="always"
                                                *ngIf="storeDeliveryForm.get('deliveryType').value === 'SCHEDULED'"
                                                class="flex flex-col w-full fuse-mat-emphasized-affix">
                                                <input
                                                    matInput
                                                    [value]="deliveryPartner.name"
                                                    [readonly]="true"/>
                                                <img
                                                    matSuffix
                                                    class="w-30"
                                                    *ngIf="deliveryPartner.providerImage"
                                                    [alt]="'Product thumbnail image'"
                                                    [src]="deliveryPartner.providerImage">
                                            </mat-form-field>
                                        </section >
            
                                        <!-- <ng-container *ngIf="storeDeliveryForm.get('deliveryType').value === 'SCHEDULED'">
                                            <section class="p-2" *ngFor="let deliveryPartner of deliveryPartners">
                                                <span class="py-0.5">{{deliveryPartner.name}}</span>
                                            </section>
                                        </ng-container> -->
                                        <mat-radio-group 
                                            *ngIf="storeDeliveryForm.get('deliveryType').value === 'ADHOC'"
                                            class="flex flex-col w-full"
                                            [formControlName]="'deliveryPartner'"
                                        >
                                            <ng-container *ngIf="deliveryPartners.length > 0; else noDeliveryPartners">
                                                <section class="p-2" *ngFor="let deliveryPartner of deliveryPartners">
                                                    <mat-radio-button [value]="deliveryPartner.id">{{deliveryPartner.name}}</mat-radio-button>
                                                </section>
                                                <mat-error *ngIf="storeDeliveryForm.get('deliveryPartner').hasError('required')">
                                                    Required at least 1
                                                </mat-error>
                                            </ng-container>
                                            <ng-template #noDeliveryPartners>
                                                <section class="p-2">
                                                    <h1 class="text-warn">Sorry there is no delivery partner for this delivery type, please choose another delivery type</h1>
                                                </section>
                                            </ng-template>
                                        </mat-radio-group>
                                    </div>
                                    &#160;
                                </div>
                            </div>
                            <!-- Self Delivery -->
                            <div *ngIf="storeDeliveryForm.get('deliveryType').value === 'SELF'" class="flex flex-col w-full">
                                <mat-label class="font-medium col-span-4">Self Delivery *</mat-label>
                                <div class="mb-0.5"></div>
                                <div class="border border-gray-300 rounded min-h-26 max-h-72 overflow-auto">
                                    <div class="flex flex-auto flex-wrap p-2">
                                        <ng-container formArrayName="allowedSelfDeliveryStates" *ngFor="let allowedSelfDeliveryState of storeDeliveryForm.get('allowedSelfDeliveryStates')['controls']; let i = index;">
                                            <ng-container [formGroupName]="i">
                                                <!-- Select Field -->
                                                <div class="flex flex-col w-full lg:w-2/4 lg:pr-2">
                                                    <mat-form-field class="w-full" appearance="fill" floatLabel="always">
                                                        <mat-select
                                                            placeholder="Select State"
                                                            [required]="true"
                                                            [formControlName]="'deliveryStates'"
                                                            [value]="allowedSelfDeliveryState.deliveryStates"
                                                            (selectionChange)="editSelfDeliveryState('deliveryStates', i, deliveryStatesSelector.value)"
                                                            #deliveryStatesSelector="matSelect"
                                                            >
                                                            <mat-select-trigger>
                                                                <span class="flex items-center">
                                                                    <span>{{ deliveryStatesSelector.triggerValue }}</span>
                                                                </span>
                                                            </mat-select-trigger>
                                                            <div>
                                                                <ng-container *ngFor="let state of statesByCountry">
                                                                    <mat-option [disabled]="checkCurrDeliveryStates(state.id)" [value]="state.id">{{ state.name }}</mat-option>
                                                                </ng-container>
                                                            </div>
                                                        </mat-select>
                                                    </mat-form-field>
                                                </div>
                                                <!-- Input Field -->
                                                <div class="flex flex-col w-full lg:w-2/4">
                                                    <div class="flex flex-col sm:flex-row">
                                                        <!-- Input -->
                                                        <mat-form-field class="flex flex-col w-full sm:w-5/6">
                                                            <span matSuffix>$</span>
                                                            <input
                                                                matInput
                                                                type="number"
                                                                placeholder="Delivery Charges"
                                                                [formControlName]="'deliveryCharges'"
                                                                [required]="true"
                                                                (change)="editSelfDeliveryState('deliveryCharges', i, $event.target.value)">
                                                        </mat-form-field>
                                                        <div class="flex flex-col w-full sm:w-1/6 sm:py-1 sm:px-2">
                                                            <input
                                                                [id]="'state-add-button' + i"
                                                                class="absolute h-0 w-0 opacity-0 invisible pointer-events-none"
                                                                type="button"
                                                                (click)="addSelfDeliveryState()"
                                                                mat-icon-button>
                                                            <label 
                                                                class="flex items-center justify-center sm:w-5 sm:h-5 rounded-full cursor-pointer hover:bg-hover"
                                                                [for]="'state-add-button'+i"
                                                                matRipple>
                                                                <mat-icon
                                                                    class="text-gray transform scale-75"
                                                                    [svgIcon]="'heroicons_outline:plus-circle'"></mat-icon>
                                                            </label>
                                                            <input
                                                                [id]="'state-remove-button'+i"
                                                                class="absolute h-0 w-0 opacity-0 invisible pointer-events-none"
                                                                type="button"
                                                                (click)="removeSelfDeliveryState(i)"
                                                                mat-icon-button>
                                                            <label 
                                                                class="flex items-center justify-center sm:w-5 sm:h-5 rounded-full cursor-pointer hover:bg-hover"
                                                                [for]="'state-remove-button'+i"
                                                                matRipple>
                                                                <mat-icon
                                                                    class="text-gray transform scale-75"
                                                                    [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                    </div>
                                    <mat-error *ngIf="storeDeliveryForm.get('deliveryType').hasError('required')">
                                        Required at least 1
                                    </mat-error>
                                    &#160;
                                </div>
                            </div>
                            <!-- Defalut -->
                            <div *ngIf="!storeDeliveryForm.get('deliveryType').value || storeDeliveryForm.get('deliveryType').value === ''" class="flex flex-col w-full">
                                <mat-label class="font-medium">Please choose a delivery type</mat-label>
                                <div class="mb-2"></div>
                                <div class="border border-gray-300 rounded h-72 overflow-auto">
                                    &nbsp;
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Actions -->
                    <div class="mt-6 flex items-center justify-end">
                        <button
                            class="ml-4"
                            mat-flat-button
                            type="button"
                            (click)="updateStoreDelivery()"
                            [color]="'primary'">Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</ng-container>